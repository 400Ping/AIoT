{% extends "base.html" %}
{% block content %}
<h2 class="mb-3">違規統計</h2>

<div class="row g-3 mb-4">
  <!-- 左邊：今天 -->
  <div class="col-md-6 d-flex">
    <div class="card shadow-sm chart-card flex-fill">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title">今天各時段違規次數</h5>
        <div class="chart-wrapper flex-grow-1">
          <canvas id="todayChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- 右邊：歷史 -->
  <div class="col-md-6 d-flex">
    <div class="card shadow-sm chart-card flex-fill">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title d-flex justify-content-between align-items-center mb-2">
          <span>歷史違規統計（每日）</span>
          <button id="resetZoomBtn" class="btn btn-sm btn-outline-secondary">
            Reset Zoom
          </button>
        </h5>
        <div class="chart-wrapper flex-grow-1">
          <canvas id="historyChart"></canvas>
        </div>
        <small class="text-muted mt-2">
          可用滑鼠滾輪縮放、拖曳平移（或框選區域放大）。
        </small>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>

<script>
  const labelsToday = {{ labels_today|tojson }};
  const valuesToday = {{ values_today|tojson }};
  const historyLabels = {{ history_labels|tojson }};
  const historyValues = {{ history_values|tojson }};

  const ctxToday = document.getElementById('todayChart').getContext('2d');
  new Chart(ctxToday, {
    type: 'bar',
    data: {
      labels: labelsToday,
      datasets: [{
        label: '違規次數',
        data: valuesToday,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  // 用外層高度
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });

  const ctxHistory = document.getElementById('historyChart').getContext('2d');
  const historyChart = new Chart(ctxHistory, {
    type: 'bar',
    data: {
      labels: historyLabels,
      datasets: [{
        label: '每日違規次數',
        data: historyValues,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      },
      plugins: {
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            drag: { enabled: true },
            mode: 'x'
          }
        }
      }
    }
  });

  document.getElementById('resetZoomBtn').addEventListener('click', () => {
    historyChart.resetZoom();
  });
</script>
{% endblock %}
